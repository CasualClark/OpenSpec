# Upstream configuration for Task MCP HTTP servers
# Supports multiple backend instances with load balancing

# Main application upstream
upstream task_mcp_backend {
    # Load balancing method (round-robin, least_conn, ip_hash, random)
    least_conn;
    
    # Backend servers - adjust based on your deployment
    server 127.0.0.1:3000 max_fails=3 fail_timeout=30s weight=1;
    # server 127.0.0.1:3001 max_fails=3 fail_timeout=30s weight=1;
    # server 127.0.0.1:3002 max_fails=3 fail_timeout=30s weight=1;
    
    # Keepalive connections for better performance
    keepalive 32;
    
    # Health check settings
    keepalive_requests 100;
    keepalive_timeout 60s;
}

# Separate upstream for SSE connections (optional, for dedicated scaling)
upstream task_mcp_sse_backend {
    least_conn;
    
    # SSE-specific backend servers
    server 127.0.0.1:3000 max_fails=3 fail_timeout=30s weight=1;
    
    # Longer keepalive for SSE connections
    keepalive 64;
    keepalive_requests 50;
    keepalive_timeout 300s;
}

# Health check upstream (can point to any backend)
upstream task_mcp_health_backend {
    server 127.0.0.1:3000 max_fails=1 fail_timeout=10s;
    keepalive 8;
}